# this file defines the CI/CD stages for the TIDO viewer.
# in some cases they invoke scripts provided at .ci-scripts/ in order to
# keep this file slim and clear. please have a look at these scripts for
# information that goes beyond the documentation of the single stages.

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - node_modules/

stages:
  - build
  - test:e2e
  - deploy

build:
  image: node:16
  stage: build
  script:
    - bash .ci-scripts/build.sh
  artifacts:
    paths:
      - dist/
    expire_in: 1 mos

test:e2e:
  image: cypress/browsers:node16.13.2-chrome100-ff98
  stage: test:e2e
  except:
    - main
  script:
    - bash .ci-scripts/build.sh
    - npm serve:prod & npm run test:e2e
  artifacts:
    when: always
    paths:
      - tests/cypress/videos/**/*.mp4
      - tests/cypress/screenshots/**/*.png
    expire_in: 1 day

pages:
  image: alpine:latest
  stage: deploy
  when: always
  script:
    - sh .ci-scripts/install-deps.sh
    - bash .ci-scripts/update-artifacts.sh
  environment:
    name: $CI_COMMIT_REF_SLUG
    url: https://subugoe.pages.gwdg.de/emo/tido/${CI_COMMIT_REF_SLUG}/
    on_stop: stop_env
  artifacts:
    name: "$CI_COMMIT_SHORT_SHA"
    paths:
      - public

stop_env:
  stage: deploy
  script:
    - echo "Remove branch env"
  environment:
    name: $CI_COMMIT_REF_SLUG
    action: stop
