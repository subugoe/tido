# this file defines the CI/CD stages for the TIDO viewer.
# in some cases they invoke scripts provided at .ci-scripts/ in order to
# keep this file slim and clear. please have a look at these scripts for
# information that goes beyond the documentation of the single stages.

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - node_modules/

stages:
  - build
  - test:e2e
  - deploy

# builds TIDO on feature and bugfix branches.
build_test:
  image: node:14
  except:
   - main
   - develop
  stage: build
  script:
   - bash .ci-scripts/build.sh
  artifacts:
    paths:
     - dist/

build_main_and_develop:
  image: node:14
  only:
   - main
   - develop
  stage: build
  script:
   - if [[ $CONTINUE_BUILD == "true" ]]; then echo "Continue build"; bash .ci-scripts/build.sh; else echo "Stop build"; fi
  artifacts:
    paths:
     - dist/
    expire_in: 1 mos

test:e2e:
  image: cypress/browsers:node14.17.0-chrome91-ff89
  except:
   - main
   - develop
  stage: test:e2e
  environment:
    name: ${CI_COMMIT_REF_SLUG}
    url: https://subugoe.pages.gwdg.de/emo/tido/${CI_COMMIT_REF_SLUG}/
  script:
   - bash .ci-scripts/build.sh
   - bash .ci-scripts/set_entrypoint_ci.sh
   - npm run dev & npm run cypress:headless
  artifacts:
    when: always
    paths:
     - cypress/videos/**/*.mp4
     - cypress/screenshots/**/*.png
    expire_in: 1 day

pages:
  image: alpine:latest
  stage: deploy
  when: always
  script:
    - sh .ci-scripts/install-deps.sh
    - if [[ $CONTINUE_BUILD == "false" && ! -d dist ]]; then echo "Build not continued. Create 404 page."; bash .ci-scripts/set-404-page.sh; else echo "Proceed page build as usual."; fi
    - bash .ci-scripts/update-artifacts.sh
  environment:
    name: ${CI_COMMIT_REF_SLUG}
    url: https://subugoe.pages.gwdg.de/emo/tido/${CI_COMMIT_REF_SLUG}/
  artifacts:
    name: "$CI_COMMIT_SHORT_SHA"
    paths:
     - public
